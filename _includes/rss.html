<div class="rss-articles"></div>
<script>
const feedURL = {{include.feed | jsonify }};
const shouldSortParent = {{include.sortParent | jsonify }} === true

function run() {
    fetch(proxyURL(feedURL))
        .then(response => response.text())
        .then(parseRSSFeed)
}

function proxyURL(url) {
    return `https://cors-proxy.johnstarich.com/proxy?url=${url}`
}

function parseRSSFeed(xmlData) {
    const dateFormatter = Intl.DateTimeFormat(undefined, { year: 'numeric', month: 'long', day: 'numeric' })
    const rss = document.querySelector(".rss-articles")
    const data = new window.DOMParser().parseFromString(xmlData, "text/xml")
    const items = Array.from(data.querySelectorAll("item"))
        .map(item => {
            let pubDate = item.querySelector("pubDate")
            if (pubDate && pubDate.textContent) {
                pubDate = Date.parse(pubDate.textContent)
            }
            return {
                title: readCDATA(item.querySelector("title")),
                link: item.querySelector("link").innerHTML,
                pubDate: pubDate,
                descriptionHTML: readCDATA(item.querySelector("description")),
            }
        })
    items.sort((a, b) => a.pubDate - b.pubDate)

    const articles = items.map(item => {
        const article = document.createElement("article")
        article.innerHTML = `
<h1>
<a class="subject" target="_blank" rel="noopener"></a>
<span class="time"></span>
</h1>
<div class="article-excerpt">
</div>`
        const linkElem = article.querySelector(".subject")
        linkElem.href = item.link
        linkElem.innerText = item.title

        const timeElem = article.querySelector(".time")
        if (item.pubDate) {
            timeElem.innerText = dateFormatter.format(item.pubDate)
        }

        const postData = document.createElement("div")
        postData.innerHTML = item.descriptionHTML
        const excerptElem = article.querySelector(".article-excerpt")

        const image = postData.querySelector(".medium-feed-image img")
        if (image) {
            excerptElem.innerHTML = `
<a class="media-link" target="_blank">
    <div class="media"></div>
</a>`
            const mediaLink = excerptElem.querySelector(".media-link")
            mediaLink.href = item.link
            const imageElem = mediaLink.firstElementChild
            const imageURL = proxyURL(image.src)
            imageElem.style["background-image"] = `url(${imageURL})`
            article.classList.add("featured-media")
        }

        const snippet = postData.querySelector(".medium-feed-snippet")
        const excerpt = snippet ? snippet.innerText : postData.innerText
        const excerptTextElem = document.createElement("p")
        excerptTextElem.innerText = excerpt
        excerptElem.appendChild(excerptTextElem)

        return article
    })
    articles.forEach(article => rss.insertAdjacentElement('afterend', article))

    if (shouldSortParent) {
        Array.from(rss.parentElement.children)
            .sort((a, b) => articleToDate(b) - articleToDate(a))
            .forEach(article => rss.parentElement.appendChild(article))
    }
    rss.remove()
}

function readCDATA(node) {
    if (!node) {
        return node
    }
    if (!node.firstChild) {
        if (node.nodeType === Node.TEXT_NODE || node.nodeType === Node.CDATA_SECTION_NODE) {
            return node.wholeText
        }
        return undefined
    }
    return readCDATA(node.firstChild)
}

function articleToDate(elem) {
    const time = elem.querySelector(".time")
    if (time && time.innerText) {
        const date = Date.parse(time.innerText)
        if (date !== NaN) {
            return date
        }
    }
    return new Date(0)
}

run()
</script>
